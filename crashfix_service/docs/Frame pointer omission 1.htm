<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en-US">

<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<title>Frame pointer omission (FPO) optimization and consequences when debugging, part 1 &laquo;  Nynaeve</title>

<link rel="stylesheet" href="http://www.nynaeve.net/wp-content/themes/default/style.css" type="text/css" media="screen" />
<link rel="pingback" href="http://www.nynaeve.net/xmlrpc.php" />

<style type="text/css" media="screen">

	#page { background: url("http://www.nynaeve.net/wp-content/themes/default/images/kubrickbgwide.jpg") repeat-y top; border: none; }

</style>


<link rel="alternate" type="application/rss+xml" title="Nynaeve &raquo; Feed" href="http://www.nynaeve.net/?feed=rss2" />
<link rel="alternate" type="application/rss+xml" title="Nynaeve &raquo; Comments Feed" href="http://www.nynaeve.net/?feed=comments-rss2" />
<link rel="alternate" type="application/rss+xml" title="Nynaeve &raquo; Frame pointer omission (FPO) optimization and consequences when debugging, part 1 Comments Feed" href="http://www.nynaeve.net/?feed=rss2&amp;p=91" />
<script type='text/javascript' src='http://www.nynaeve.net/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.nynaeve.net/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.nynaeve.net/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Nynaeve' href='http://www.nynaeve.net' />
<link rel='start' title='And so the blog begins&#8230;' href='http://www.nynaeve.net/?p=1' />
<link rel='prev' title='Impressions of Vista' href='http://www.nynaeve.net/?p=90' />
<link rel='next' title='The kernel object namespace and Win32, part 3' href='http://www.nynaeve.net/?p=92' />
<meta name="generator" content="WordPress 3.0.4" />
<link rel='canonical' href='http://www.nynaeve.net/?p=91' />
</head>
<body class="single single-post postid-91">
<div id="page">


<div id="header" role="banner">
	<div id="headerimg">
		<h1><a href="http://www.nynaeve.net/">Nynaeve</a></h1>
		<div class="description">Adventures in Windows debugging and reverse engineering.</div>
	</div>
</div>
<hr />

	<div id="content" class="widecolumn" role="main">

	
		<div class="navigation">
			<div class="alignleft">&laquo; <a href="http://www.nynaeve.net/?p=90" rel="prev">Impressions of Vista</a></div>
			<div class="alignright"><a href="http://www.nynaeve.net/?p=92" rel="next">The kernel object namespace and Win32, part 3</a> &raquo;</div>
		</div>

		<div class="post-91 post type-post hentry category-debugging category-programming category-windows" id="post-91">
			<h2>Frame pointer omission (FPO) optimization and consequences when debugging, part 1</h2>

			<div class="entry">
				<p>During the course of debugging programs, you&#8217;ve probably ran into the term &#8220;FPO&#8221; once or twice.  FPO refers to a specific class of compiler optimizations that, on x86, deal with how the compiler accesses local variables and stack-based arguments.</p>
<p>With a function that uses local variables (and/or stack-based arguments), the compiler needs a mechanism to reference these values on the stack.  Typically, this is done in one of two ways:</p>
<ul>
<li>Access local variables directly from the stack pointer (<em>esp</em>).  This is the behavior if FPO optimization is enabled.  While this does not require a separate register to track the location of locals and arguments, as is needed if FPO optimization is disabled, it makes the generated code slightly more complicated.  In particular, the displacement from <em>esp</em> of locals and arguments actually changes as the function is executed, due to things like function calls or other instructions that modify the stack.  As a result, the compiler must keep track of the actual displacement from the current <em>esp</em> value at each location in a function where a stack-based value is referenced.  This is typically not a big deal for a compiler to do, but in hand written assembler, this can get a bit tricky.</li>
<li>Dedicate a register to point to a fixed location on the stack relative to local variables and and stack-based arguments, and use this register to access locals and arguments.  This is the behavior if FPO optimization is disabled.  The convention is to use the <em>ebp</em> register to access locals and stack arguments.  <em>Ebp</em> is typically setup such that the first stack argument can be found at <em>[ebp+08]</em>, with local variables typically at a negative displacement from <em>ebp</em>.</li>
</ul>
<p>A typical prologue for a function with FPO optimization disabled might look like this:</p>
<pre>push   ebp               ; save away old ebp (nonvolatile)
mov    ebp, esp          ; load ebp with the stack pointer
sub    esp, sizeoflocals ; reserve space for locals
...                      ; rest of function</pre>
<p>The main concept is that FPO optimization is disabled, a function will immediately save away <em>ebp</em> (as the first operation touching the stack), and then load <em>ebp</em> with the current stack pointer.  This sets up a stack layout like so (relative to <em>ebp</em>):</p>
<pre>[ebp-01]   Last byte of the last local variable
[ebp+00]   Old ebp value
[ebp+04]   Return address
[ebp+08]   First argument...</pre>
<p>Thereafter, the function will always use <em>ebp</em> to access locals and stack based arguments.  (The prologue of the function may vary a bit, especially with functions using a variation __SEH_prolog to setup an initial SEH frame, but the end result is always the same with respect to the stack layout relative to <em>ebp</em>.)</p>
<p>This does (as previously stated) make it so that the <em>ebp</em> register is not available for other uses to the register allocator.  However, this performance hit is usually not enough to be a large concern relative to a function compiled with FPO optimization turned on.  Furthermore, there are a number of conditions that require a function to use a frame pointer which you may hit anyway:</p>
<ul>
<li>Any function using SEH must use a frame pointer, as when an exception occurs, there is no way to know the displacement of local variables from the <em>esp</em> value (stack pointer) at exception dispatching (the exception could have happened anywhere, and operations like making function calls or setting up stack arguments for a function call modify the value of <em>esp</em>).</li>
<li>Any function using automatic C++ objects with destructors must use SEH for compiler unwind support.  This means that most C++ functions end up with FPO optimization disabled.  (It is possible to change the compiler assumptions about SEH exceptions and C++ unwinding, but the default [and recommended setting] is to unwind objects when an SEH exception occurs.)</li>
<li>Any function using _alloca to dynamically allocate memory on the stack must use a frame pointer (and thus have FPO optimization disabled), as the displacement from <em>esp</em> for local variables and arguments can change at runtime and is not known to the compiler at compile time when code is being generated.</li>
</ul>
<p>Because of these restrictions, many functions you may be writing will already have FPO optimization disabled, without you having explicitly turned it off.  However, it is still likely that many of your functions that do not meet the above criteria have FPO optimization enabled, and thus do not use <em>ebp</em> to reference locals and stack arguments.</p>
<p>Now that you have a general idea of just what FPO optimization does, I&#8217;ll cover cover why it is to your advantage to turn off FPO optimization globally when debugging certain classes of problems in the second half of this series.  (It is actually the case that most shipping Microsoft system code turns off FPO as well, so you can rest assured that a real cost benefit analysis has been done between FPO and non-FPO optimized code, and it is overall better to disable FPO optimization in the general case.)</p>
<p><em>Update: <a title="Pavel's comment" href="?p=91#comments">Pavel Lebedinsky</a> points out that the C++ support for SEH exceptions is disabled by default for new projects in VS2005 (and that it is no longer the recommended setting).  For most programs built prior to VS2005 and using the defaults at that time, though, the above statement about C++ destructors causing SEH to be used for a function (and thus requiring the use of a frame pointer) still applies.</em></p>

								
				<p class="postmetadata alt">
					<small>
						This entry was posted
												on Tuesday, November 21st, 2006 at 2:16 pm						and is filed under <a href="http://www.nynaeve.net/?cat=2" title="View all posts in Debugging" rel="category">Debugging</a>, <a href="http://www.nynaeve.net/?cat=4" title="View all posts in Programming" rel="category">Programming</a>, <a href="http://www.nynaeve.net/?cat=5" title="View all posts in Windows" rel="category">Windows</a>.
						You can follow any responses to this entry through the <a href='http://www.nynaeve.net/?feed=rss2&amp;p=91'>RSS 2.0</a> feed.

													You can <a href="#respond">leave a response</a>, or <a href="http://www.nynaeve.net/wp-trackback.php?p=91" rel="trackback">trackback</a> from your own site.

						
					</small>
				</p>

			</div>
		</div>

	
<!-- You can start editing here. -->

	<h3 id="comments">7 Responses to &#8220;Frame pointer omission (FPO) optimization and consequences when debugging, part 1&#8221;</h3>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>

	<ol class="commentlist">
			<li class="comment byuser comment-author-dispensa even thread-even depth-1" id="comment-499">
				<div id="div-comment-499" class="comment-body">
				<div class="comment-author vcard">
		<img alt='' src='http://0.gravatar.com/avatar/0e9a44f02bef218fbd23764fc9ff6d0e?s=32&amp;d=http%3A%2F%2Fwww.nynaeve.net%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://kernelmustard.com' rel='external nofollow' class='url'>dispensa</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-499">
			November 22, 2006 at 12:13 am</a>		</div>

		<p>> The convention is to use the ebp register to access locals and stack arguments. Ebp is typically setup such that the first stack argument can be found at [ebp+08], with local variables typically at a negative displacement from ebp.</p>
<p>I think it&#8217;s probably fair to say it&#8217;s more than convention; ebp (== base pointer) is one of the few registers whose segment default is SS (the only other one being esp?). The rest reference DS or CS. </p>
<p>I know it&#8217;s not a problem on Windows, since the segments (other than FS/GS) all match, but in principle, these are implicit 48-bit addresses, and EDI, for example, can&#8217;t be used to reference the stack without an override.</p>
<p>Now, with that completely theoretical assertion out of the way, do you run across a lot of generated code using register-indirect addressing into the stack with ESI/EDI/etc. as a base?</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-500">
				<div id="div-comment-500" class="comment-body">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/7f32bf7795a7caf182c4572d6f9d90fe?s=32&amp;d=http%3A%2F%2Fwww.nynaeve.net%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://www.valhallalegends.com/skywing' rel='external nofollow' class='url'>Skywing</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-500">
			November 22, 2006 at 12:19 am</a>		</div>

		<p>No.  I would assume this is primarily because of their use in inline memcmp/strcmp/memcpy.</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="comment even thread-even depth-1" id="comment-503">
				<div id="div-comment-503" class="comment-body">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/9d7d595b8508fab1457cc89d1f62500f?s=32&amp;d=http%3A%2F%2Fwww.nynaeve.net%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Pavel Lebedinsky</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-503">
			November 22, 2006 at 3:41 am</a>		</div>

		<p>As of VS 2005, the default is to not invoke local destructors for SEH exceptions:</p>
<p><a href="http://msdn2.microsoft.com/en-us/library/1deeycx5.aspx" rel="nofollow">http://msdn2.microsoft.com/en-us/library/1deeycx5.aspx</a></p>
<p>/EHa still works but generally is not recommended.</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-524">
				<div id="div-comment-524" class="comment-body">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/bddbb2936daa4b3b6dfc17561cacb286?s=32&amp;d=http%3A%2F%2Fwww.nynaeve.net%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn">Vladimir Scherbina</cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-524">
			November 23, 2006 at 4:30 pm</a>		</div>

		<p>Skywing, </p>
<p>Did you managed /Oy to work? I did some tests in past and they failed. </p>
<p>Simple code that compares dword value with zero looks identical in both cases: when compiling with /Oy and w/o /Oy: (this is what I have in both cases)</p>
<p> ; HRESULT DllCanUnloadNow(void)<br />
.text:10005650                 public DllCanUnloadNow<br />
.text:10005650 DllCanUnloadNow proc near<br />
.text:10005650                 push    ebp<br />
.text:10005651                 mov     ebp, esp<br />
.text:10005653                 xor     eax, eax<br />
.text:10005655                 cmp     dword_10010078, 0<br />
.text:1000565C                 setnz   al<br />
.text:1000565F                 pop     ebp<br />
.text:10005660                 retn<br />
.text:10005660 DllCanUnloadNow endp</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="pingback even thread-even depth-1" id="comment-653">
				<div id="div-comment-653" class="comment-body">
				<div class="comment-author vcard">
				<cite class="fn"><a href='http://www.nynaeve.net/?p=97' rel='external nofollow' class='url'>Nynaeve &raquo; Blog Archive &raquo; Frame pointer omission (FPO) optimization and consequences when debugging, part 2</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-653">
			December 6, 2006 at 12:28 pm</a>		</div>

		<p>[...] Frame pointer omission (FPO) and consequences when debugging, part 1. [...]</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="comment byuser comment-author-admin bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-656">
				<div id="div-comment-656" class="comment-body">
				<div class="comment-author vcard">
		<img alt='' src='http://1.gravatar.com/avatar/7f32bf7795a7caf182c4572d6f9d90fe?s=32&amp;d=http%3A%2F%2Fwww.nynaeve.net%2Fwp-includes%2Fimages%2Fblank.gif&amp;r=G' class='avatar avatar-32 photo' height='32' width='32' />		<cite class="fn"><a href='http://www.valhallalegends.com/skywing' rel='external nofollow' class='url'>Skywing</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-656">
			December 6, 2006 at 9:47 pm</a>		</div>

		<p>Vladimir: Try using &#8220;/Oy-&#8221;.  Also, I&#8217;ve noticed that there are a lot of places where recent compilers (e.g. VS2005) will absolutely insist on using EBP when they don&#8217;t really *need* to per-se, such as functions with array local variables.  So, you might have a bit of trouble in getting CL 14 / VS2005 to omit code to use EBP as a frame in some cases (i.e. forcing CL to use direct ESP accesses).</p>

		<div class="reply">
				</div>
				</div>
		</li>
		<li class="pingback even thread-even depth-1" id="comment-25982">
				<div id="div-comment-25982" class="comment-body">
				<div class="comment-author vcard">
				<cite class="fn"><a href='http://jpassing.wordpress.com/2008/05/01/ksplice-safe-enough/' rel='external nofollow' class='url'>Ksplice &#8212; safe enough? &laquo; JP&#8217;s Blog</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://www.nynaeve.net/?p=91&amp;cpage=1#comment-25982">
			May 1, 2008 at 3:47 am</a>		</div>

		<p>[...] on Windows, it is still a problem that cannot be easily dismissed. Finally, optimizations such as Frame Pointer Omission can thwart attempts to perform a stack walk by following the [...]</p>

		<div class="reply">
				</div>
				</div>
		</li>
	</ol>

	<div class="navigation">
		<div class="alignleft"></div>
		<div class="alignright"></div>
	</div>
 


<div id="respond">

<h3>Leave a Reply</h3>

<div class="cancel-comment-reply">
	<small><a rel="nofollow" id="cancel-comment-reply-link" href="/?p=91#respond" style="display:none;">Click here to cancel reply.</a></small>
</div>


<form action="http://www.nynaeve.net/wp-comments-post.php" method="post" id="commentform">


<p><input type="text" name="author" id="author" value="" size="22" tabindex="1" aria-required='true' />
<label for="author"><small>Name (required)</small></label></p>

<p><input type="text" name="email" id="email" value="" size="22" tabindex="2" aria-required='true' />
<label for="email"><small>Mail (will not be published) (required)</small></label></p>

<p><input type="text" name="url" id="url" value="" size="22" tabindex="3" />
<label for="url"><small>Website</small></label></p>


<!--<p><small><strong>XHTML:</strong> You can use these tags: <code>&lt;a href=&quot;&quot; title=&quot;&quot;&gt; &lt;abbr title=&quot;&quot;&gt; &lt;acronym title=&quot;&quot;&gt; &lt;b&gt; &lt;blockquote cite=&quot;&quot;&gt; &lt;cite&gt; &lt;code&gt; &lt;del datetime=&quot;&quot;&gt; &lt;em&gt; &lt;i&gt; &lt;q cite=&quot;&quot;&gt; &lt;strike&gt; &lt;strong&gt; </code></small></p>-->

<p><textarea name="comment" id="comment" cols="100%" rows="10" tabindex="4"></textarea></p>

<p><input name="submit" type="submit" id="submit" tabindex="5" value="Submit Comment" />
<input type='hidden' name='comment_post_ID' value='91' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p>

</form>

</div>


	
	</div>


<hr />
<div id="footer" role="contentinfo">
<!-- If you'd like to support WordPress, having the "powered by" link somewhere on your blog is the best way; it's our only promotion or advertising. -->
	<p>
		Nynaeve is proudly powered by
		<a href="http://wordpress.org/">WordPress</a>
		<br /><a href="http://www.nynaeve.net/?feed=rss2">Entries (RSS)</a>
		and <a href="http://www.nynaeve.net/?feed=comments-rss2">Comments (RSS)</a>.
		<!-- 23 queries. 0.898 seconds. -->
	</p>
</div>
</div>

<!-- Gorgeous design by Michael Heilemann - http://binarybonsai.com/kubrick/ -->

		</body>
</html>

<!-- Dynamic Page Served (once) in 0.897 seconds -->
